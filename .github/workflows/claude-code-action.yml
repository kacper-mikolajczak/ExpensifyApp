name: Claude Code Action (Manual)

on:
  pull_request:
    types: [ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to target for inline comments"
        required: true
      repo_owner:
        description: "Repository owner (optional, defaults to this repo owner)"
        required: false
      repo_name:
        description: "Repository name (optional, defaults to this repo)"
        required: false

jobs:
  dispatch-pr-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    env:
      # For workflow_dispatch: use inputs; for pull_request: use event context
      REPO_OWNER: ${{ github.event.inputs.repo_owner || github.repository_owner }}
      REPO_NAME: ${{ github.event.inputs.repo_name || github.event.repository.name || github.event.repository.name }}
      PR_NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Simulate pull_request event for this run
        # Prepare a minimal pull_request event payload so the action will
        # treat a workflow_dispatch run like a pull_request run.
        run: |
          # Ensure directory exists for GITHUB_EVENT_PATH, then override it.
          mkdir -p "$(dirname "$GITHUB_EVENT_PATH")"
          cat > "$GITHUB_EVENT_PATH" <<EOF
          {
            "pull_request": {
              "number": ${PR_NUMBER}
            },
            "repository": {
              "full_name": "${REPO_OWNER}/${REPO_NAME}",
              "name": "${REPO_NAME}",
              "owner": { "login": "${REPO_OWNER}" }
            }
          }
          EOF
          # Tell toolkit that this is a pull_request event
          echo "GITHUB_EVENT_NAME=pull_request" >> "$GITHUB_ENV"
          echo "Wrote simulated pull_request event to \$GITHUB_EVENT_PATH"

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@a7e4c51380c42dd89b127f5e5f9be7b54020bc6b # v1.0.21
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: "PR #${{ env.PR_NUMBER }} of repository ${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}"
          claude_args: |
            --system-prompt "/tell-a-joke"
            --json-schema '{"type": "object", "properties": {"joke": {"type": "string"}}}'
            --allowedTools "Bash(gh pr view:*),Bash(gh pr diff:*),mcp__github_inline_comment__create_inline_comment"
